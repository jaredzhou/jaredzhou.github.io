<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Jared's Site</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="jared"><meta name=description content="Jared的个人博客"><meta name=keywords content="Hugo,theme,jane"><meta name=generator content="Hugo 0.104.3"><link rel=canonical href=https://jaredzhou.github.io/><link href=/index.xml rel=alternate type=application/rss+xml title="Jared's Site"><link rel=icon href=/favicon.ico><link rel=stylesheet href=/sass/jane.min.f1e506a781bf25d33ffc18aa6b4e972a965c58049d27d4f92b7db2e9bf28e4bf.css integrity="sha256-8eUGp4G/JdM//Biqa06XKpZcWASdJ9T5K32y6b8o5L8=" media=screen crossorigin=anonymous><meta property="og:title" content="Jared's Site"><meta property="og:description" content="Jared的个人博客"><meta property="og:type" content="website"><meta property="og:url" content="https://jaredzhou.github.io/"><meta itemprop=name content="Jared's Site"><meta itemprop=description content="Jared的个人博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="Jared's Site"><meta name=twitter:description content="Jared的个人博客"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Jared's Site</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=https://jaredzhou.github.io/>Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://jaredzhou.github.io/post/>Posts</a></li></ul></nav><link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css><link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header id=header class="header container"><div class=logo-wrapper><a href=/ class=logo>Jared's Site</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://jaredzhou.github.io/>Home</a></li><li class=menu-item><a class=menu-item-link href=https://jaredzhou.github.io/post/>Posts</a></li></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight"><div class=content-wrapper><div id=content class="content container"><section id=posts class=posts><article class="post bg-white"><header class=post-header><h1 class=post-title><a class=post-link href=/post/rust-iterators/>Rust Iterators</a></h1><div class=post-meta><time datetime=2022-10-20 class=post-time>2022-10-20</time></div></header><div class=post-content><div class=post-summary><p>本文是对<a href=https://www.oreilly.com/library/view/programming-rust-2nd/9781492052586/>Programming Rust</a> 第15章的总结，部分代码与图片来自此书</p><h3 id=一个简单的例子>一个简单的例子</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>//normal style   
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..=</span><span class=mi>10</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//iterator style
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=o>..=</span><span class=mi>10</span><span class=p>).</span><span class=n>fold</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>|</span><span class=n>sum</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=o>|</span><span class=w> </span><span class=n>sum</span><span class=o>+</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>sum</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>以上两种求和的实现是等价， 基于<code>iterator</code>的实现风格对于函数式编程是很常见的， rust也提倡这种方式的写法，不同的是，rust编译器在编译的时候会对这种表达方式进行优化，达到一种<code>zero cost abstraction</code>的效果， 比如以上的求和在编译器优化后可能汇编代码使用<code>11*10/2</code>这种数学公式来执行。这个意思是不用太担心<code>iterator</code>风格的性能问题， rust编译器会进行必要的优化，使得我们使用的时候表达能力与性能兼顾</p><h3 id=intointerator和iterator><code>IntoInterator</code>和<code>Iterator</code></h3><p>在rust中iterator最基本的两个trait是<code>IntoInterator</code>和<code>Iterator</code>，他们的定义如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>trait</span><span class=w> </span><span class=nb>Iterator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>type</span> <span class=nc>Item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>fn</span> <span class=nf>next</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Item</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>..</span><span class=p>.</span><span class=w> </span><span class=c1>// many default methods
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>trait</span><span class=w> </span><span class=nb>IntoIterator</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=bp>Self</span>::<span class=n>IntoIter</span>:<span class=nb>Iterator</span><span class=o>&lt;</span><span class=n>Item</span><span class=o>=</span><span class=bp>Self</span>::<span class=n>Item</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>type</span> <span class=nc>Item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>type</span> <span class=nc>IntoIter</span>: <span class=nb>Iterator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>fn</span> <span class=nf>into_iter</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span>::<span class=n>IntoIter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>IntoIterator</code>用来生成<code>Iterator</code>, 实现<code>Iterator</code>可以进行相应的操作， <code>Iterator</code>trait包含了很多函数， 但是需要实现的只有一个<code>next</code>.</p><p>值得一提的是<code>IntoIterator</code>的<code>into_iter</code>使用传值的方式，也就表明了这个方法会将原始类型给消费掉， 进行<code>Copy</code>或者<code>Move</code>, 比如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c1>//into_iter() move the vecotr v
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span><span class=w> </span><span class=n>iter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>into_iter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>以上的代码不能编译通过， 因为v已经被<code>Move</code>了， 你可以使用引用来避免这个问题</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c1>//以下两种方式等价
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span><span class=w> </span><span class=n>iter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=o>&amp;</span><span class=n>v</span><span class=p>).</span><span class=n>into_iter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>iter2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>iter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>由于这个使用方式很常见， 所以<code>Vec</code>直接提供了方法<code>Vec&lt;T>::iter()</code>， 他会返回一个生成<code>&T</code>类型的<code>Iterator</code></p><p>rust中的<code>for loop</code>其实是使用<code>Iterator</code>来实现的，以下的代码是等价的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=o>&amp;</span><span class=n>v</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c1>//translate to this by compiler
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>iter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>iter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>iter</span><span class=p>.</span><span class=n>next</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>很多时候可以使用<code>IntoIterator</code>作为泛型的边界来使用，比如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>fmt</span>::<span class=n>Debug</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>dump</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>U</span><span class=o>&gt;</span><span class=p>(</span><span class=n>t</span>: <span class=nc>T</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>T</span>: <span class=nb>IntoIterator</span><span class=o>&lt;</span><span class=n>Item</span><span class=o>=</span><span class=n>U</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>U</span>: <span class=nc>Debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>u</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{:?}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>u</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在这个例子里面，表示T必须是一种可以产生<code>Iterator</code>， 这个<code>Iterator&lt;U></code>产出的类型<code>U</code>必须是实现了<code>Debug</code>的</p><h4 id=drain方法><code>drain</code>方法</h4><p>很多<code>collection</code>提供了<code>drain</code>方法， 它通过<code>collection</code>的可变引用返回一个<code>Iterator</code>, 当这个<code>Iteratro</code> drop之后， 这些被包含的元素就从<code>colleciton</code>当中移除了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kd>let</span><span class=w> </span><span class=n>drain_iter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>drain</span><span class=p>(</span><span class=mi>2</span><span class=o>..</span><span class=mi>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=fm>assert_eq!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=fm>vec!</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>]);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=标准库应用>标准库应用</h4><p><code>Iterator</code>在标准库中有广泛的应用， 不止在<code>collection</code>中， 还在很多其他方面， 比如<code>io</code>当中， 使用<code>Iterator</code>来处理io流， 尤其在异步io中。</p><p>另外对<code>Iterator</code>风格代码的使用， 对于非函数式编程习惯的人员来说有一定的门槛，需要多练习才能适应，下面将重点介绍以下<code>Iterator</code>适配器</p><h3 id=iterator适配器><code>Iterator</code>适配器</h3><p>rust的<code>Iterator</code>适配器非常灵活，下面将逐个介绍</p><h5 id=map-and-filter><code>map</code> and <code>filter</code></h5><p>这两个应该很好理解</p><p>统一处理<code>Vec</code>中的元素</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>text</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34; ponies \n giraffes\niguanas 
</span></span></span><span class=line><span class=cl><span class=s>    \nsquid&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>v</span>: <span class=nb>Vec</span><span class=o>&lt;&amp;</span><span class=kt>str</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>text</span><span class=p>.</span><span class=n>lines</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>map</span><span class=p>(</span><span class=kt>str</span>::<span class=n>trim</span><span class=p>)</span><span class=w> </span><span class=c1>////map的FnMut类型为FnMut(I::Item) -&gt; B, Item由上一个Iterator决定， B由这个FnMut决定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=p>.</span><span class=n>collect</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=p>[</span><span class=s>&#34;ponies&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;giraffes&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;iguanas&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;squid&#34;</span><span class=p>]);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>过滤<code>Vec</code>中的元素</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>text</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34; ponies \n giraffes\niguanas 
</span></span></span><span class=line><span class=cl><span class=s>\nsquid&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>v</span>: <span class=nb>Vec</span><span class=o>&lt;&amp;</span><span class=kt>str</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>text</span><span class=p>.</span><span class=n>lines</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>.</span><span class=n>map</span><span class=p>(</span><span class=kt>str</span>::<span class=n>trim</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>.</span><span class=n>filter</span><span class=p>(</span><span class=o>|</span><span class=n>s</span><span class=o>|</span><span class=w> </span><span class=o>*</span><span class=n>s</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s>&#34;iguanas&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>//FnMut(&amp;Self::Item) -&gt; bool， Item由上一个Iterator决定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=p>.</span><span class=n>collect</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=p>[</span><span class=s>&#34;ponies&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;giraffes&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;squid&#34;</span><span class=p>]);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>需要注意的是</p><ol><li>rust中adaptor是<code>lazy</code>的，也就是说不管chain了多少个adaptor，这些操作只有被消费的时候才执行，具体就是只有adaptor调用了<code>collect</code>的时候， 操作才被真正执行</li><li>adaptor是<code>zero cost abstraction</code>， 这意味着rust编译器会将这些chain内联到最后消费的地方， 比如执行的时候就像是一个for循环语句一样，这样做可以明显的提高执行效率</li></ol><h5 id=filter_map-and-flat_map><code>filter_map</code> and <code>flat_map</code></h5><p><code>filter_map</code>有点像<code>map</code>和<code>filter</code>的组合体， 它要么转换一个值，要么丢弃一个值，使用<code>filter_map</code>有时候比使用组合方式更加方便和优雅， 比如只有在你转换一个值的时候才能决定是否要丢弃一个值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>text</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;1\nfrond .25 289\n3.1415 estuary\n&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>text</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>.</span><span class=n>split_whitespace</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>.</span><span class=n>filter_map</span><span class=p>(</span><span class=o>|</span><span class=n>w</span><span class=o>|</span><span class=w> </span><span class=kt>f64</span>::<span class=n>from_str</span><span class=p>(</span><span class=n>w</span><span class=p>).</span><span class=n>ok</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{:4.2}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>number</span><span class=p>.</span><span class=n>sqrt</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在上个例子中， 你只有做数字转换的时候才知道要不要保留这个值</p><p>flat_map就是在每个FnMut中制造出一个<code>Iterator</code>, 然后再把这些<code>Iterator</code>合并起来， 当然这些都是语义层面的， 真正执行的时候， 编译器会做相应的优化, 可能并不会真的做<code>Iterator</code>合并</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>major_cities</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HashMap</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>major_cities</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&#34;Japan&#34;</span><span class=p>,</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=s>&#34;Tokyo&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Kyoto&#34;</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>major_cities</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&#34;The United States&#34;</span><span class=p>,</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=s>&#34;Portland&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;Nashville&#34;</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>major_cities</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&#34;Brazil&#34;</span><span class=p>,</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=s>&#34;São Paulo&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Brasília&#34;</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>major_cities</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&#34;Kenya&#34;</span><span class=p>,</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=s>&#34;Nairobi&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Mombasa&#34;</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>major_cities</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&#34;The Netherlands&#34;</span><span class=p>,</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=s>&#34;Amsterdam&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;Utrecht&#34;</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>countries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s>&#34;Japan&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Brazil&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Kenya&#34;</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=o>&amp;</span><span class=n>city</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>countries</span><span class=p>.</span><span class=n>iter</span><span class=p>().</span><span class=n>flat_map</span><span class=p>(</span><span class=o>|</span><span class=n>country</span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&amp;</span><span class=n>major_cities</span><span class=p>[</span><span class=n>country</span><span class=p>])</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>city</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=flatten><code>flatten</code></h5><p><code>flatten</code>就是值将<code>Iterator</code>中的每个元素也当成<code>Iterator</code>，然后取第二级中的元素作为输出， flatten通常是值将2层级变为1层级的操作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>parks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BTreeMap</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>parks</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&#34;Portland&#34;</span><span class=p>,</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=s>&#34;Mt. Tabor Park&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Forest Park&#34;</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>parks</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&#34;Kyoto&#34;</span><span class=p>,</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=s>&#34;Tadasu-no-Mori Forest&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Maruyama
</span></span></span><span class=line><span class=cl><span class=s>Koen&#34;</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>parks</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&#34;Nashville&#34;</span><span class=p>,</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=s>&#34;Percy Warner Park&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Dragon
</span></span></span><span class=line><span class=cl><span class=s>Park&#34;</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Build a vector of all parks. `values` gives us an iterator producing
</span></span></span><span class=line><span class=cl><span class=c1>// vectors, and then `flatten` produces each vector&#39;s elements in turn.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span><span class=w> </span><span class=n>all_parks</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>_</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>parks</span><span class=p>.</span><span class=n>values</span><span class=p>().</span><span class=n>flatten</span><span class=p>().</span><span class=n>cloned</span><span class=p>().</span><span class=n>collect</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>all_parks</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=s>&#34;Tadasu-no-Mori Forest&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Maruyama Koen&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Percy
</span></span></span><span class=line><span class=cl><span class=s>Warner Park&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=s>&#34;Dragon Park&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Mt. Tabor Park&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Forest Park&#34;</span><span class=p>])</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>上面的示例将<code>Vec</code>元素打平成<code>&str</code>作为结果， 3个<code>Vec</code>变成了6个<code>&str</code></p><p><code>flatten</code>与<code>Option</code>配合使用将会有很妙的效果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=fm>assert_eq!</span><span class=p>(</span><span class=fm>vec!</span><span class=p>[</span><span class=nb>None</span><span class=p>,</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=s>&#34;day&#34;</span><span class=p>),</span><span class=w> </span><span class=nb>None</span><span class=p>,</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=s>&#34;one&#34;</span><span class=p>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>.</span><span class=n>into_iter</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>.</span><span class=n>flatten</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>.</span><span class=n>collect</span>::<span class=o>&lt;</span><span class=nb>Vec</span><span class=o>&lt;</span><span class=n>_</span><span class=o>&gt;&gt;</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=s>&#34;day&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;one&#34;</span><span class=p>]);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>上面的示例将<code>Vec&lt;Option></code>变成了<code>Vec&lt;&str></code>， 这是因为<code>Option</code>本生也实现了<code>IntoIterator</code> 返回了非<code>None</code>的值，同样的方式也适用于<code>Result</code></p><p>有的时候<code>flatten</code>与<code>map</code>的组合其实就等于<code>flat_map</code>， 这种情况下使用<code>flat_map</code>会显得更方便与直接</p><h3 id=其他><code>其他</code></h3><p>其他还有很多常用的适配器，比如<code>take</code>, <code>skip</code>， <code>peekable</code>, <code>fuse</code>, <code>chain</code> 等等，暂且不做讨论</p></div></div></article><article class="post bg-white"><header class=post-header><h1 class=post-title><a class=post-link href=/post/rust-structs/>Rust Struct</a></h1><div class=post-meta><time datetime=2022-10-16 class=post-time>2022-10-16</time></div></header><div class=post-content><div class=post-summary><p>本文是对<a href=https://www.oreilly.com/library/view/programming-rust-2nd/9781492052586/>Programming Rust</a> 第9章的总结，部分代码与图片来自此书</p><h1 id=struct>Struct</h1><h3 id=基本用法>基本用法</h3><p>在rust中， struct分为三种类型，分别为<code>named</code>, <code>tuple-like</code>, <code>unit-like</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>struct</span> <span class=nc>User</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span>: <span class=kt>usize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>manager</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>Rc</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Point</span><span class=p>(</span><span class=kt>usize</span><span class=p>,</span><span class=w> </span><span class=kt>usize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>empty</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>关联方法可以使用<code>self</code>, <code>&self</code>, <code>&mut self</code>, <code>Box&lt;Self></code>, <code>Rc&lt;Self</code>>等self参数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>impl</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=n>id</span>: <span class=kt>usize</span><span class=p>,</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>User</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>id</span>: <span class=nc>id</span><span class=p>,</span><span class=w> </span><span class=n>name</span>: <span class=nc>name</span><span class=p>,</span><span class=w> </span><span class=n>manager</span>: <span class=nb>None</span> <span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>get_name</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>String</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>name</span><span class=p>.</span><span class=n>clone</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>set_name</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>move_user</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>User</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>manage</span><span class=p>(</span><span class=bp>self</span>: <span class=nc>Rc</span><span class=o>&lt;</span><span class=bp>Self</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>user</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>User</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>user</span><span class=p>.</span><span class=n>manager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=bp>self</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以这样调用这些方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>User</span>::<span class=n>new</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s>&#34;jared&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>manager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>User</span>::<span class=n>new</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>&#34;jerry&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//&amp;mut self
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>member</span><span class=p>.</span><span class=n>set_name</span><span class=p>(</span><span class=s>&#34;abc&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//&amp;self
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>member</span><span class=p>.</span><span class=n>get_name</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//Rc&lt;Self&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Rc</span>::<span class=n>new</span><span class=p>(</span><span class=n>manager</span><span class=p>).</span><span class=n>manage</span><span class=p>(</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>member</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//Box&lt;Self&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>m2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Box</span>::<span class=n>new</span><span class=p>(</span><span class=n>member</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>m2</span><span class=p>.</span><span class=n>get_name</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>调用函数时， 类型会自动转换(<code>implicit conversion</code>), 当然是在满足规则的情况下， 一个<code>&self</code>是没办法自动转换成一个<code>&mut self</code>， 相反则是成立的</p><h3 id=内部可变性>内部可变性</h3><p>有的时候， 你需要在程序中共享一些struct， 比如说配置参数，由于使用Rc， 这个时候这个配置结构是不可变的。但是很多时候， 你还是希望可以修改它的某些属性， 这个时候就要用到内部可变性</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>//配置参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>Config</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>path</span>: <span class=nc>RefCell</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timeout</span>: <span class=mi>5</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//实例
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>Instance</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>conf</span>: <span class=nc>Rc</span><span class=o>&lt;</span><span class=n>RefCell</span><span class=o>&lt;</span><span class=n>Config</span><span class=o>&gt;&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//共享配置参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Rc</span>::<span class=n>new</span><span class=p>(</span><span class=n>Config</span><span class=p>{</span><span class=n>path</span>: <span class=nc>RefCell</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;/abc&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>()),</span><span class=n>timeout</span>: <span class=mi>5</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>ins</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Instance</span><span class=p>{</span><span class=n>conf</span>: <span class=nc>config</span><span class=p>.</span><span class=n>clone</span><span class=p>()};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=n>ins2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Instance</span><span class=p>{</span><span class=n>conf</span>: <span class=nc>config</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//Config本身是immutable的， 但是可以通过内部可变性，改变path的值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ins</span><span class=p>.</span><span class=n>conf</span><span class=p>.</span><span class=n>path</span><span class=p>.</span><span class=n>borrow_mut</span><span class=p>().</span><span class=n>replace</span><span class=p>(</span><span class=s>&#34;abc&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;xyz&#34;</span><span class=p>)</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ins2</span><span class=p>.</span><span class=n>conf</span><span class=p>.</span><span class=n>path</span><span class=p>.</span><span class=n>borrow</span><span class=p>());</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>内部可变性的问题在于， 它打破了rust编译期的借用规则， 但是在运行期，如果它同时存在一个可变引用与不可变引用，程序会<code>panic</code>, 也就是说在运行期它依然要遵循借用规则</p></div></div></article><article class="post bg-white"><header class=post-header><h1 class=post-title><a class=post-link href=/post/rust-references-more/>Rust Shared And Mutable References</a></h1><div class=post-meta><time datetime=2022-10-15 class=post-time>2022-10-15</time></div></header><div class=post-content><div class=post-summary><p>本文是对<a href=https://www.oreilly.com/library/view/programming-rust-2nd/9781492052586/>Programming Rust</a> 第5章的总结，部分代码与图片来自此书</p><h1 id=共享引用与可变引用>共享引用与可变引用</h1><p>虽然可以同时存在多个共享引用，但是当共享引用存在的时候，不但不能够存在可变引用，甚至你也不能修改或者<code>move</code> 拥有者本身，比如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>,</span><span class=w> </span><span class=mi>19</span><span class=p>,</span><span class=w> </span><span class=mi>27</span><span class=p>,</span><span class=w> </span><span class=mi>34</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>v</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>aside</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w> </span><span class=c1>// move vector to aside
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>r</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span><span class=w> </span><span class=c1>// bad: uses `v`, which is now uninitialized
</span></span></span></code></pre></td></tr></table></div></div><p>上面的<code>v</code> 在被引用的时候<code>move</code>给了<code>r</code>， 这种操作是编译器禁止的</p><p>一个场景是在编程当中经常出现的，比如你需要复制字符串自身,使用rust，你可能会这样实现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>extend</span><span class=p>(</span><span class=n>vec</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>f64</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>slice</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>f64</span><span class=p>])</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>elt</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>slice</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>vec</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=o>*</span><span class=n>elt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>wave</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mf>0.0</span><span class=p>,</span><span class=w> </span><span class=mf>1.0</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>extend</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>wave</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>wave</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>但是这种操作是被编译器禁止的，由于修改<code>wave</code>的时候很可能改变它的内存地址，比如扩充大小，这个时候<code>slice</code>指向 了已经被摧毁的内存地址，程序就会出现访问无效内存的问题，以下是示意图</p><p><img src=/sharedmut.png alt></p><p>这些编译错误使我们重新看一下rust的引用规则</p><ul><li><p>共享访问</p><p>被共享引用的值是只读的，在共享引用的周期内， 这个值不能被改变，即使是通过变量本身也不行</p></li><li><p>排他访问</p></li></ul><p>​ 可变引用是排他的， 在可变引用周期内， 这个值甚至不能被访问，唯一的例外就是可以<code>reborrow</code>这个可变引用</p><p>一下是一些体现这些规则的例子</p><h3 id=共享引用期间不能修改>共享引用期间不能修改</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>y</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>11</span><span class=p>;</span><span class=w>  </span><span class=c1>//can not change y
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=可变引用期间不能问>可变引用期间不能问</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>   </span><span class=c1>//can not use of mut borrowed y, even it is copy type
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>y</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=n>z</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=p>;</span><span class=w>  </span><span class=c1>//can not access y
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>      </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;{}, {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>z</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=从共享引用reborrow>从共享引用<code>reborrow</code></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>107</span><span class=p>,</span><span class=w> </span><span class=mi>109</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>w</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>r0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>w</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{:?}, {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=从可变引用reborrow>从可变引用<code>reborrow</code></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>101</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>w</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>m0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=c1>//reborrow mutable from m
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// let m0 = &amp;mut w.0; //not possible, can only reborrow from m
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>r1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>.</span><span class=mi>1</span><span class=p>;</span><span class=w>  </span><span class=c1>//reborrow shared from m
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// let v = w.0; //can not accessed, because of mut borrowed by m
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;{:?}, {}&#34;</span><span class=p>,</span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=n>m0</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这些限制可能看起来很奇怪，也会限制灵活性。 但是能排除一些安全隐患， 最典型的就是同时操作自身的例子，比如操作一个文件，我们很可能会复制自身</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>struct</span> <span class=nc>File</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>descriptor</span>: <span class=kt>i32</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>new_file</span><span class=p>(</span><span class=n>d</span>: <span class=kt>i32</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>File</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>File</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>descriptor</span>: <span class=nc>d</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>clone_from</span><span class=p>(</span><span class=n>this</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>File</span><span class=p>,</span><span class=w> </span><span class=n>rhs</span>: <span class=kp>&amp;</span><span class=nc>File</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>close</span><span class=p>(</span><span class=n>this</span><span class=p>.</span><span class=n>descriptor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>this</span><span class=p>.</span><span class=n>descriptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dup</span><span class=p>(</span><span class=n>rhs</span><span class=p>.</span><span class=n>descriptor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>new_file</span><span class=p>(</span><span class=n>open</span><span class=p>(</span><span class=s>&#34;foo.txt&#34;</span><span class=p>,</span><span class=w> </span><span class=o>..</span><span class=p>.));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>..</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>clone_from</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>f</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>如果以上代码能够执行，那么显然跟我们预期不太一样， 一个我们希望复制的文件已经被关闭了</p><p>这些现在也会在并发编程的时候带来一些好处， 因为并发中的竞争就是因为多个线程对于同个变量的修改导致的。但是rust中并不允许同时存在多个可变引用。</p><h1 id=对象海>对象海</h1><p>垃圾回收机制的引入通常导致了对象海的产生，开发者会在代码中将各个对象互相引用， 这样做可能会提高一点开发效率，但是由于缺乏良好的设计，随着代码量的增加，系统很快就会变成一团乱麻，难以维护， rust严格的所有权机制会使开发者提前思考系统设计，写出更好，更加可维护的程序</p></div></div></article></section><nav class=pagination><ul><li class=active><a href=/>1</a></li><li><a href=/page/2/>2</a></li><li><a href=/page/3/>3</a></li></ul></nav></div></div></main><footer id=footer class=footer><div class=icon-links><a href=mailto:zhouzhenyu1313@163.com rel="me noopener" class=iconfont title=email><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg></a><a href=https://github.com/jaredzhou rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg></a><a href=https://jaredzhou.github.io/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a></span>
<span class=copyright-year>&copy;
2021 -
2022
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg></i></span><span class=author>jared</span></span>
<span id=busuanzi_container>访客数/访问量：<span id=busuanzi_value_site_uv></span>/<span id=busuanzi_value_site_pv></span></span></div></footer><div class=back-to-top id=back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>